local Players = game:GetService("Players")
local player = Players.LocalPlayer
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

shared.autoFarm = true

-- Tìm nút Ranked
local function findRankedButton()
    for _, guiObj in ipairs(player:WaitForChild("PlayerGui"):GetChildren()) do
        if guiObj:IsA("ScreenGui") then
            for _, obj in ipairs(guiObj:GetDescendants()) do
                if obj:IsA("GuiButton") and obj.Visible and obj.Name == "Ranked" then
                    return obj
                end
            end
        end
    end
    return nil
end

-- Tìm nút Play
local function findPlayButton()
    for _, guiObj in ipairs(player:WaitForChild("PlayerGui"):GetChildren()) do
        if guiObj:IsA("ScreenGui") then
            local btn = guiObj:FindFirstChild("Play", true)
            if btn and btn:IsA("GuiButton") and btn.Visible then
                return btn
            end
        end
    end
    return nil
end

-- Kiểm tra nút đứng yên đủ lâu
local function waitUntilStable(button, stableTime, maxWait)
    local startTime = tick()
    local stableStart = tick()
    local lastPos = button.AbsolutePosition

    while tick() - startTime < maxWait do
        if not button:IsDescendantOf(game) or not button.Visible then
            stableStart = tick()
            lastPos = button.AbsolutePosition
            task.wait(0.1)
            continue
        end

        local nowPos = button.AbsolutePosition
        if (nowPos - lastPos).magnitude > 1 then
            stableStart = tick()
        elseif tick() - stableStart >= stableTime then
            return true
        end

        lastPos = nowPos
        task.wait(0.1)
    end

    return false
end

-- Nhấn nút Play
local function pressPlay(playBtn)
    if playBtn and playBtn:IsA("GuiButton") and playBtn.Visible then
        GuiService.SelectedObject = playBtn
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        print("[AutoPlay] Đã nhấn nút Play.")
        return true
    end
    return false
end

-- Vòng lặp chính
task.spawn(function()
    while true do
        if not shared.autoFarm then
            task.wait(2)
            continue
        end

        if not player.Character then
            local ranked = findRankedButton()
            local playBtn = findPlayButton()

            if ranked and playBtn then
                print("[AutoPlay] Tìm thấy nút Ranked. Đợi ổn định...")
                if waitUntilStable(ranked, 1.5, 10) then
                    print("[AutoPlay] Ranked đã ổn định. Đang nhấn nút Play...")
                    if pressPlay(playBtn) then
                        -- Đợi tới khi Character xuất hiện hoặc nút Play biến mất
                        local confirmStart = tick()
                        while tick() - confirmStart < 10 do
                            if player.Character or not playBtn.Visible then
                                print("[AutoPlay] Đã vào game thành công.")
                                break
                            end
                            task.wait(0.2)
                        end
                    end
                else
                    print("[AutoPlay] Ranked không ổn định kịp thời gian.")
                end
            else
                print("[AutoPlay] Không tìm thấy Ranked hoặc Play.")
            end
        end

        task.wait(1)
    end
end)
