local Players = game:GetService("Players")
local player = Players.LocalPlayer
local GuiService = game:GetService("GuiService")
local VirtualInputManager = game:GetService("VirtualInputManager")

shared.autoFarm = true

-- Tìm nút Ranked
local function findRankedButton()
    for _, guiObj in ipairs(player:WaitForChild("PlayerGui"):GetChildren()) do
        if guiObj:IsA("ScreenGui") then
            for _, obj in ipairs(guiObj:GetDescendants()) do
                if obj:IsA("GuiButton") and obj.Visible and obj.Name == "Ranked" then
                    return obj
                end
            end
        end
    end
    return nil
end

-- Kiểm tra nút có đứng yên không
local function waitUntilStable(button, duration, timeout)
    local lastPos = button.AbsolutePosition
    local stableStart = tick()
    local timeStart = tick()

    while tick() - timeStart < (timeout or 10) do
        if not button:IsDescendantOf(game) or not button.Visible then
            stableStart = tick()
            lastPos = button.AbsolutePosition
            task.wait(0.1)
            continue
        end

        local currentPos = button.AbsolutePosition
        if (currentPos - lastPos).magnitude < 2 then
            if tick() - stableStart >= duration then
                return true
            end
        else
            stableStart = tick()
        end
        lastPos = currentPos
        task.wait(0.1)
    end
    return false
end

-- Nhấn nút Play
local function pressPlay()
    for _, guiObj in ipairs(player:WaitForChild("PlayerGui"):GetChildren()) do
        if guiObj:IsA("ScreenGui") then
            local playBtn = guiObj:FindFirstChild("Play", true)
            if playBtn and playBtn:IsA("GuiButton") and playBtn.Visible then
                GuiService.SelectedObject = playBtn
                task.wait(0.1)
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.Return, false, game)
                task.wait(0.05)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.Return, false, game)
                print("[AutoPlay] Đã nhấn nút Play.")
                return
            end
        end
    end
end

-- Vòng lặp chính
task.spawn(function()
    while true do
        if not shared.autoFarm then
            task.wait(2)
            continue
        end

        if shared.autoFarm and not player.Character then
            local rankedBtn = findRankedButton()
            if rankedBtn then
                print("[AutoPlay] Tìm thấy Ranked. Đang đợi ổn định...")
                local ok = waitUntilStable(rankedBtn, 1.5, 10)
                if ok then
                    pressPlay()
                else
                    print("[AutoPlay] Ranked chưa ổn định.")
                end
            else
                print("[AutoPlay] Không tìm thấy Ranked.")
            end
        end

        task.wait(1)
    end
end)
